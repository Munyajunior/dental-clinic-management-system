<!-- src/templates/email/password_reset.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Reset Request - KwantaDent Dental Clinic Management System</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; 
            line-height: 1.6; 
            color: #1f2937; 
            margin: 0; 
            padding: 0; 
            background: #f8fafc;
        }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            background: #ffffff; 
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .header { 
            background: linear-gradient(135deg, #ef4444, #dc2626, #b91c1c);
            color: white; 
            padding: 30px; 
            text-align: center; 
        }
        .content { 
            padding: 40px; 
            background: #ffffff; 
        }
        .reset-box { 
            background: #fef2f2; 
            border: 2px solid #ef4444; 
            border-radius: 12px; 
            padding: 25px; 
            margin: 25px 0; 
            text-align: center;
            position: relative;
        }
        .footer { 
            text-align: center; 
            padding: 30px; 
            color: #6b7280; 
            font-size: 14px; 
            background: #f8fafc;
            border-top: 1px solid #e5e7eb;
        }
        .button { 
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white; 
            padding: 16px 32px; 
            text-decoration: none; 
            border-radius: 10px; 
            display: inline-block; 
            font-weight: 600;
            font-size: 18px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);
            margin: 15px 0;
            min-width: 250px;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px -1px rgba(239, 68, 68, 0.4);
        }
        .button:active {
            transform: translateY(0);
        }
        .security-note { 
            background: #fef3c7; 
            border-left: 4px solid #f59e0b; 
            padding: 16px; 
            margin: 20px 0; 
            border-radius: 6px;
        }
        .manual-token { 
            background: #f3f4f6; 
            padding: 15px; 
            border-radius: 8px; 
            font-family: 'Courier New', monospace; 
            font-size: 16px; 
            letter-spacing: 1px;
            margin: 15px 0;
            border: 1px dashed #d1d5db;
            word-break: break-all;
        }
        .step { 
            background: #f8fafc; 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 8px; 
            border-left: 4px solid #ef4444; 
        }
        .badge {
            display: inline-block;
            background: #ef4444;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        .urgency-indicator {
            display: inline-flex;
            align-items: center;
            background: #fef3c7;
            color: #92400e;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .deeplink-info {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .mobile-deeplink {
            background: #f0f9ff;
            border: 2px solid #3b82f6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        .copy-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px 5px;
            transition: background 0.2s ease;
        }
        .copy-btn:hover {
            background: #2563eb;
        }
        .copy-btn.copied {
            background: #10b981;
        }
        .url-box {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
            margin: 10px 0;
            border: 1px solid #d1d5db;
        }
        .url-link {
            color: #3b82f6;
            text-decoration: none;
        }
        .url-link:hover {
            text-decoration: underline;
        }
        @media (max-width: 600px) {
            .content {
                padding: 25px;
            }
            .button {
                display: block;
                width: 100%;
                padding: 18px 24px;
                font-size: 16px;
                text-align: center;
                box-sizing: border-box;
            }
            .mobile-deeplink {
                margin: 15px 0;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 style="margin: 0; font-size: 28px; font-weight: 700;">Password Reset Request</h1>
            <p style="margin: 10px 0 0 0; font-size: 16px; opacity: 0.9;">Secure your account</p>
        </div>
        
        <div class="content">
            <p>Dear <strong>{{ user_name }}</strong>,</p>
            
            <p>We received a request to reset your password for your <strong>{{ clinic_name }}</strong> account. For your security, we've initiated the password reset process.</p>

            <div class="urgency-indicator">
                ‚è∞ This reset link expires in {{ expiry_hours }} hours
            </div>
            
            <div class="reset-box">
                <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #b91c1c;">Reset Your Password</h3>
                    <span class="badge">SECURE</span>
                </div>
                
                <p style="margin-bottom: 20px; color: #6b7280;">Click the button below to securely reset your password in the application:</p>
                
                <!-- MAIN DEEP LINK BUTTON -->
                <div style="text-align: center; margin: 25px 0;">
                    <a href="{{ deep_link_url }}" 
                       class="button" 
                       style="text-decoration: none; color: white;"
                       onclick="handleDeepLinkClick(event, '{{ deep_link_url }}', '{{ web_fallback_url }}')">
                        üîí Reset Password in Application
                    </a>
                    <p style="font-size: 14px; color: #6b7280; margin-top: 10px;">
                        One-click security ‚Ä¢ Opens directly in {{ app_name }}<br>
                        <small>If the app doesn't open, <a href="#manual-section" style="color: #3b82f6; text-decoration: none; cursor: pointer;" onclick="showManualInstructions()">click here for alternatives</a></small>
                    </p>
                </div>
                
                <!-- DEEP LINK INFO -->
                <div class="deeplink-info">
                    <p style="margin: 0; font-size: 14px;">
                        <strong>How this works:</strong> Clicking the button above will automatically open 
                        <strong>{{ app_name }}</strong> using the <code>{{ scheme_name }}://</code> protocol. 
                        If you don't have the app installed, you'll be prompted to download it.
                    </p>
                </div>
            </div>
            
            <!-- PLATFORM-SPECIFIC INSTRUCTIONS -->
            {% if platform and platform.instructions %}
            <div class="step">
                <h4 style="margin: 0 0 10px 0; color: #b91c1c;">
                    üì± Platform-Specific Instructions for {{ platform.os }}
                </h4>
                {{ platform.instructions|safe }}
            </div>
            {% endif %}
            
            <!-- MOBILE OPTIMIZED DEEP LINK (Hidden by default, shown by JavaScript) -->
            <div id="mobile-deeplink" class="mobile-deeplink" style="display: none;">
                <h4 style="margin: 0 0 15px 0; color: #1e40af;">üì± Mobile Device Detected</h4>
                <p style="margin: 0 0 15px 0; color: #4b5563;">Tap the button below to open the {{ app_name }} app:</p>
                <a href="{{ deep_link_url }}" 
                   class="button" 
                   style="text-decoration: none; color: white; background: linear-gradient(135deg, #3b82f6, #1d4ed8);"
                   onclick="handleDeepLinkClick(event, '{{ deep_link_url }}', '{{ web_fallback_url }}')">
                    Open in {{ app_name }} App
                </a>
                <p style="font-size: 13px; color: #6b7280; margin: 15px 0 0 0;">
                    Having trouble? <a href="#manual-section" style="color: #3b82f6; text-decoration: none; cursor: pointer;" onclick="showManualInstructions()">View manual instructions</a>
                </p>
            </div>
            
            <h3 style="color: #b91c1c; border-bottom: 2px solid #ef4444; padding-bottom: 8px; margin-top: 30px;">Reset Instructions</h3>
            
            <div class="step">
                <h4 style="margin: 0 0 10px 0; color: #b91c1c;">Option 1: One-Click Reset (Recommended)</h4>
                <p style="margin: 0;">Click the "Reset Password in Application" button above. This will automatically open {{ app_name }} and pre-fill your reset token.</p>
            </div>
            
            <!-- MANUAL INSTRUCTIONS SECTION -->
            <div id="manual-section" class="step" style="display: none;">
                <h4 style="margin: 0 0 15px 0; color: #b91c1c;">üõ†Ô∏è Alternative Setup Methods</h4>
                
                <div style="margin: 20px 0;">
                    <strong>Method 1: Copy & Paste Token</strong>
                    <div class="manual-token" id="reset-token">{{ reset_token }}</div>
                    <button class="copy-btn" onclick="copyToClipboard('{{ reset_token }}', this)">
                        üìã Copy Token
                    </button>
                    <button class="copy-btn" onclick="copyToClipboard('{{ deep_link_url }}', this, 'Deep Link')">
                        üìã Copy Deep Link
                    </button>
                    <p style="font-size: 14px; color: #6b7280; margin: 10px 0 0 0;">
                        Paste this token in the password reset screen
                    </p>
                </div>
                
                <div style="margin: 20px 0;">
                    <strong>Method 2: Direct URL</strong>
                    <div class="url-box">
                        <a href="{{ web_fallback_url }}" 
                           class="url-link"
                           onclick="handleWebLinkClick(event, '{{ web_fallback_url }}')">
                            {{ web_fallback_url }}
                        </a>
                    </div>
                    <button class="copy-btn" onclick="copyToClipboard('{{ web_fallback_url }}', this, 'URL')">
                        üìã Copy URL
                    </button>
                    <p style="font-size: 14px; color: #6b7280; margin: 10px 0 0 0;">
                        Open this URL in your browser for web-based password reset
                    </p>
                </div>
                
                <div style="margin: 20px 0;">
                    <strong>Method 3: Manual Entry</strong>
                    <ol style="margin: 10px 0; padding-left: 20px;">
                        <li>Open {{ app_name }} application</li>
                        <li>Go to Login ‚Üí Forgot Password</li>
                        <li>Enter this code: <strong>{{ reset_token }}</strong></li>
                        <li>Create your new password</li>
                        <li>Log in with your new credentials</li>
                    </ol>
                </div>
            </div>
            
            <div class="step">
                <h4 style="margin: 0 0 10px 0; color: #b91c1c;">Password Requirements</h4>
                <p style="margin: 0;">
                    ‚Ä¢ Use a password that's at least 12 characters long<br>
                    ‚Ä¢ Include uppercase, lowercase, numbers, and symbols<br>
                    ‚Ä¢ Avoid using personal information or common words<br>
                    ‚Ä¢ Consider using a password manager
                </p>
            </div>

            <div class="security-note">
                <strong>üîí Security Alert:</strong> If you didn't request this password reset, please:<br>
                1. <strong>Ignore this email</strong> - your current password remains safe<br>
                2. <strong>Review your account activity</strong> in the application<br>
                3. <strong>Contact support immediately</strong> if you notice suspicious activity<br>
                4. <strong>Consider enabling two-factor authentication</strong> for added security
            </div>
            
            <div style="background: #eff6ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 20px; margin: 25px 0;">
                <h4 style="margin: 0 0 10px 0; color: #1e40af;">üí° Security Best Practices</h4>
                <ul style="margin: 0; padding-left: 20px;">
                    <li>Use a unique password for each service</li>
                    <li>Enable two-factor authentication in application settings</li>
                    <li>Regularly review your login activity</li>
                    <li>Keep your application updated to the latest version</li>
                </ul>
            </div>
            
            <p><strong>Need Immediate Assistance?</strong></p>
            <p>Our security team is available to help:</p>
            <ul>
                <li>üìß <strong>Email:</strong> <a href="mailto:{{ support_email }}" style="color: #3b82f6; text-decoration: none;">{{ support_email }}</a></li>
                <li>üìû <strong>WhatsApp:</strong> {{ whatsapp_support }}</li>
                <li>üîí <strong>Security Concerns:</strong> <a href="mailto:security@kwantabit.com" style="color: #3b82f6; text-decoration: none;">security@kwantabit.com</a></li>
                <li>üìû <strong>Emergency Line:</strong> +237 682549261</li>
                <li>üîß <strong>Application Help:</strong> <a href="https://support.kwantabit.com/password-reset" style="color: #3b82f6; text-decoration: none;">Password Reset Guide</a></li>
            </ul>
            
            <p>Stay secure,<br>
            <strong>The {{ clinic_name }} Security Team</strong><br>
            Powered by KwantaBit Technologies</p>
        </div>
        
        <div class="footer">
            <p style="margin: 0 0 10px 0;">
                <strong>KwantaBit Technologies Inc.</strong><br>
                Enterprise Security & Compliance
            </p>
            <p style="margin: 0; font-size: 12px; color: #9ca3af;">
                ¬© {{ now().year }} KwantaBit Technologies. All rights reserved.<br>
                This is an automated security message from our enterprise system, Please do not reply to this email.<br>
                <a href="https://kwantabit.com/privacy" style="color: #6b7280; text-decoration: none;">Privacy Policy</a> ‚Ä¢ 
                <a href="https://kwantabit.com/security" style="color: #6b7280; text-decoration: none;">Security Information</a> ‚Ä¢ 
                <a href="https://kwantabit.com/compliance" style="color: #6b7280; text-decoration: none;">Compliance</a>
            </p>
            <p style="margin: 15px 0 0 0; font-size: 11px; color: #9ca3af;">
                This email was triggered by a password reset request for account: {{ user_email }}<br>
                If this wasn't you, please contact our security team immediately.<br>
                Request ID: {{ reset_token[:8] }}...{{ reset_token[-8:] }}
            </p>
        </div>
    </div>

    <script>
    // Enhanced JavaScript for deep link handling and user interaction
    
    // Detect if we're on a mobile device
    function isMobileDevice() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    }
    
    // Show mobile-specific deep link section
    if (isMobileDevice()) {
        document.getElementById('mobile-deeplink').style.display = 'block';
    }
    
    // Handle deep link clicks with fallback
    function handleDeepLinkClick(event, deepLinkUrl, fallbackUrl) {
        event.preventDefault();
        
        // Try to open the deep link
        window.location.href = deepLinkUrl;
        
        // Set a timeout to check if the deep link worked
        // If we're still in the email client after 1.5 seconds, show fallback
        setTimeout(function() {
            // This will only execute if the deep link failed
            showManualInstructions();
            
            // Optionally open the fallback URL in a new tab
            window.open(fallbackUrl, '_blank');
        }, 1500);
        
        // Track the click (in a real implementation, you'd send this to analytics)
        console.log('Deep link clicked:', deepLinkUrl);
    }
    
    // Handle web link clicks (standard HTTP URLs)
    function handleWebLinkClick(event, url) {
        event.preventDefault();
        window.open(url, '_blank');
        console.log('Web link clicked:', url);
    }
    
    // Show manual instructions section
    function showManualInstructions() {
        var manualSection = document.getElementById('manual-section');
        if (manualSection) {
            manualSection.style.display = 'block';
            manualSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    }
    
    // Copy text to clipboard
    function copyToClipboard(text, button, label) {
        // Create a temporary textarea
        var textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        
        // Select and copy
        textarea.select();
        textarea.setSelectionRange(0, 99999); // For mobile devices
        
        try {
            var successful = document.execCommand('copy');
            
            // Visual feedback
            if (button) {
                var originalText = button.innerHTML;
                button.innerHTML = '‚úì Copied!';
                button.classList.add('copied');
                
                // Reset button after 2 seconds
                setTimeout(function() {
                    button.innerHTML = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }
            
            // Show success message
            alert((label || 'Text') + ' copied to clipboard!');
            console.log('Copied to clipboard:', text.substring(0, 50) + '...');
            
        } catch (err) {
            console.error('Failed to copy:', err);
            alert('Failed to copy. Please copy manually.');
        }
        
        // Clean up
        document.body.removeChild(textarea);
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Add click tracking for analytics (in a real implementation)
        var links = document.querySelectorAll('a[href*="kwantabit-kwantadent://"], a[href*="reset-password"]');
        links.forEach(function(link) {
            link.addEventListener('click', function() {
                // You could send this data to your analytics service
                var linkType = this.href.includes('kwantabit-kwantadent://') ? 'deep_link' : 'web_link';
                console.log('Password reset link clicked - Type:', linkType, 'URL:', this.href);
            });
        });
        
        // Auto-show manual instructions if deep link appears to have failed
        // This is a simple heuristic - in reality, you'd have better detection
        if (window.location.hash === '#manual') {
            showManualInstructions();
        }
    });
    
    // QR code generation for tokens (placeholder for future enhancement)
    function generateQRCode(token) {
        // This would integrate with a QR code library
        console.log('QR code generation would go here for token:', token.substring(0, 20) + '...');
        // In a real implementation, you might use something like:
        // new QRCode(document.getElementById("qrcode"), token);
    }
    
    // Token expiration countdown (optional)
    function startExpirationCountdown(hours) {
        var expirationTime = new Date();
        expirationTime.setHours(expirationTime.getHours() + hours);
        
        // Update countdown every minute
        setInterval(function() {
            var now = new Date();
            var timeLeft = expirationTime - now;
            
            if (timeLeft <= 0) {
                // Token expired
                document.querySelector('.urgency-indicator').innerHTML = 
                    '‚è∞ This reset link has expired. Please request a new one.';
                document.querySelector('.urgency-indicator').style.background = '#fee2e2';
                document.querySelector('.urgency-indicator').style.color = '#991b1b';
            } else {
                var hoursLeft = Math.floor(timeLeft / (1000 * 60 * 60));
                var minutesLeft = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                
                document.querySelector('.urgency-indicator').innerHTML = 
                    '‚è∞ This reset link expires in ' + hoursLeft + 'h ' + minutesLeft + 'm';
            }
        }, 60000); // Update every minute
    }
    
    // Start countdown if expiry_hours is available
    if (expiry_hours){
        document.addEventListener('DOMContentLoaded', function() {
        startExpirationCountdown(expiry_hours);
    });
    }
    
    
    </script>
</body>
</html>