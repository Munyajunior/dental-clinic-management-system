<!-- src/templates/email/password_reset.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password Reset Request - Dental Clinic Management System</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; 
            line-height: 1.6; 
            color: #1f2937; 
            margin: 0; 
            padding: 0; 
            background: #f8fafc;
        }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            background: #ffffff; 
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .header { 
            background: linear-gradient(135deg, #ef4444, #dc2626, #b91c1c);
            color: white; 
            padding: 30px; 
            text-align: center; 
        }
        .content { 
            padding: 40px; 
            background: #ffffff; 
        }
        .reset-box { 
            background: #fef2f2; 
            border: 2px solid #ef4444; 
            border-radius: 12px; 
            padding: 25px; 
            margin: 25px 0; 
            text-align: center;
            position: relative;
        }
        .footer { 
            text-align: center; 
            padding: 30px; 
            color: #6b7280; 
            font-size: 14px; 
            background: #f8fafc;
            border-top: 1px solid #e5e7eb;
        }
        .button { 
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white; 
            padding: 14px 28px; 
            text-decoration: none; 
            border-radius: 8px; 
            display: inline-block; 
            font-weight: 600;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);
            margin: 15px 0;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px -1px rgba(239, 68, 68, 0.4);
        }
        .security-note { 
            background: #fef3c7; 
            border-left: 4px solid #f59e0b; 
            padding: 16px; 
            margin: 20px 0; 
            border-radius: 6px;
        }
        .manual-token { 
            background: #f3f4f6; 
            padding: 15px; 
            border-radius: 8px; 
            font-family: 'Courier New', monospace; 
            font-size: 16px; 
            letter-spacing: 1px;
            margin: 15px 0;
            border: 1px dashed #d1d5db;
        }
        .step { 
            background: #f8fafc; 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 8px; 
            border-left: 4px solid #ef4444; 
        }
        .badge {
            display: inline-block;
            background: #ef4444;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        .urgency-indicator {
            display: inline-flex;
            align-items: center;
            background: #fef3c7;
            color: #92400e;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        @media (max-width: 600px) {
            .content {
                padding: 25px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 style="margin: 0; font-size: 28px; font-weight: 700;">Password Reset Request</h1>
            <p style="margin: 10px 0 0 0; font-size: 16px; opacity: 0.9;">Secure your account</p>
        </div>
        
        <div class="content">
            <p>Dear <strong>{{ user_name }}</strong>,</p>
            
            <p>We received a request to reset your password for your <strong>{{ clinic_name }}</strong> account. For your security, we've initiated the password reset process.</p>

            <div class="urgency-indicator">
                ‚è∞ This reset link expires in {{ expiry_hours }} hours
            </div>
            
            <div class="reset-box">
                <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; color: #b91c1c;">Reset Your Password</h3>
                    <span class="badge">SECURE</span>
                </div>
                
                <p style="margin-bottom: 20px; color: #6b7280;">Click the button below to securely reset your password in the application:</p>
                
                <div style="text-align: center;">
    <a href="{{ deep_link_url }}" 
       class="button" 
       onclick="window.open('{{ deep_link_url }}'); return false;"
       target="_blank"
       style="text-decoration: none; color: white; background: linear-gradient(135deg, #ef4444, #dc2626); padding: 14px 28px; border-radius: 8px; display: inline-block; font-weight: 600; font-size: 16px; border: none; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3); margin: 15px 0;">
        üîí Reset Password in Application
    </a>
    <p style="font-size: 14px; color: #6b7280;">
        One-click security ‚Ä¢ Opens directly in KwantaBit Dental<br>
        <small>If the app doesn't open, <a href="#manual-instructions" style="color: #3b82f6;">click here for alternatives</a></small>
    </p>
</div>
            
            <h3 style="color: #b91c1c; border-bottom: 2px solid #ef4444; padding-bottom: 8px;">Reset Instructions</h3>
            
            <div class="step">
                <h4 style="margin: 0 0 10px 0; color: #b91c1c;">Option 1: One-Click Reset (Recommended)</h4>
                <p style="margin: 0;">Click the "Reset Password in Application" button above. This will automatically open KwantaBit Dental and pre-fill your reset token.</p>
            </div>
            
            <div class="step">
                <h4 style="margin: 0 0 10px 0; color: #b91c1c;">Option 2: Manual Reset</h4>
                <p style="margin: 0;">
                    <strong>If the button doesn't work:</strong><br>
                    1. Open KwantaBit Dental application<br>
                    2. Go to Login ‚Üí Forgot Password<br>
                    3. Enter this code: <strong>{{ reset_token }}</strong><br>
                    4. Create your new password
                </p>
            </div>
            
            <div class="step">
                <h4 style="margin: 0 0 10px 0; color: #b91c1c;">Password Requirements</h4>
                <p style="margin: 0;">
                    ‚Ä¢ Use a password that's at least 12 characters long<br>
                    ‚Ä¢ Include uppercase, lowercase, numbers, and symbols<br>
                    ‚Ä¢ Avoid using personal information or common words<br>
                    ‚Ä¢ Consider using a password manager
                </p>
            </div>

            <div class="security-note">
                <strong>üîí Security Alert:</strong> If you didn't request this password reset, please:<br>
                1. <strong>Ignore this email</strong> - your current password remains safe<br>
                2. <strong>Review your account activity</strong> in the application<br>
                3. <strong>Contact support immediately</strong> if you notice suspicious activity<br>
                4. <strong>Consider enabling two-factor authentication</strong> for added security
            </div>
            
            <div style="background: #eff6ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 20px; margin: 25px 0;">
                <h4 style="margin: 0 0 10px 0; color: #1e40af;">üí° Security Best Practices</h4>
                <ul style="margin: 0; padding-left: 20px;">
                    <li>Use a unique password for each service</li>
                    <li>Enable two-factor authentication in application settings</li>
                    <li>Regularly review your login activity</li>
                    <li>Keep your application updated to the latest version</li>
                </ul>
            </div>
            
            <p><strong>Need Immediate Assistance?</strong></p>
            <p>Our security team is available to help:</p>
            <ul>
                <li>üìß <strong>Email:</strong> <a href="mailto:{{ support_email }}">{{ support_email }}</a></li>
                <li>üìû <strong>WhatsApp:</strong> {{ whatsapp_support }}</li>
                <li>üîí <strong>Security Concerns:</strong> <a href="mailto:security@kwantabit.com">security@kwantabit.com</a></li>
                <li>üìû <strong>Emergency Line:</strong> +237 682549261</li>
                <li>üîß <strong>Application Help:</strong> <a href="https://support.kwantabit.com/password-reset">Password Reset Guide</a></li>
            </ul>
            
            <p>Stay secure,<br>
            <strong>The KwantaBit Technologies Security Team</strong></p>
        </div>
        
        <div class="footer">
            <p style="margin: 0 0 10px 0;">
                <strong>KwantaBit Technologies Inc.</strong><br>
                Enterprise Security & Compliance
            </p>
            <p style="margin: 0; font-size: 12px; color: #9ca3af;">
                ¬© 2025 KwantaBit Technologies. All rights reserved.<br>
                This is an automated security message from our enterprise system, Please do not reply to this email.<br>
                <a href="https://kwantabit.com/privacy" style="color: #6b7280;">Privacy Policy</a> ‚Ä¢ 
                <a href="https://kwantabit.com/security" style="color: #6b7280;">Security Information</a> ‚Ä¢ 
                <a href="https://kwantabit.com/compliance" style="color: #6b7280;">Compliance</a>
            </p>
            <p style="margin: 15px 0 0 0; font-size: 11px; color: #9ca3af;">
                This email was triggered by a password reset request for account: {{ user_email }}<br>
                If this wasn't you, please contact our security team immediately.
            </p>
        </div>
    </div>
    <script>
    // Enhanced deep link handling with fallbacks
    document.addEventListener('DOMContentLoaded', function() {
        // Track deep link clicks
        var deepLinkButtons = document.querySelectorAll('a.button, a[href*="kwantabit-dental://"]');
        deepLinkButtons.forEach(function(button) {
            button.addEventListener('click', function(e) {
                // Track click event
                console.log('Password reset deep link clicked');
                
                // For email clients that support JavaScript, we can enhance the experience
                var href = this.getAttribute('href');
                
                // Check if it's a deep link
                if (href.startsWith('kwantabit-dental://')) {
                    // Try to open the deep link
                    window.location.href = href;
                    
                    // Fallback: If deep link fails, show manual instructions
                    setTimeout(function() {
                        // If we're still in the email client after 2 seconds,
                        // the deep link probably didn't work
                        var manualSection = document.getElementById('manual-instructions');
                        if (manualSection) {
                            manualSection.style.display = 'block';
                            manualSection.scrollIntoView({ behavior: 'smooth' });
                        }
                    }, 2000);
                }
            });
        });
        
        // Copy token functionality for email clients that support it
        var copyButtons = document.querySelectorAll('.copy-token');
        copyButtons.forEach(function(button) {
            button.addEventListener('click', function() {
                var tokenElement = document.querySelector('.manual-token');
                if (tokenElement) {
                    var tokenText = tokenElement.textContent.trim();
                    
                    // Try to use Clipboard API
                    if (navigator.clipboard && window.isSecureContext) {
                        navigator.clipboard.writeText(tokenText).then(function() {
                            button.textContent = '‚úì Copied!';
                            setTimeout(function() {
                                button.textContent = 'üìã Copy Token';
                            }, 2000);
                        }).catch(function(err) {
                            console.error('Failed to copy:', err);
                        });
                    } else {
                        // Fallback for older browsers
                        var textArea = document.createElement('textarea');
                        textArea.value = tokenText;
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                            button.textContent = '‚úì Copied!';
                            setTimeout(function() {
                                button.textContent = 'üìã Copy Token';
                            }, 2000);
                        } catch (err) {
                            console.error('Fallback copy failed:', err);
                        }
                        document.body.removeChild(textArea);
                    }
                }
            });
        });
    });
</script>

<!-- Add this section for enhanced mobile experience -->
<div id="mobile-deeplink" style="display: none; background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 8px; padding: 15px; margin: 15px 0;">
    <h4 style="margin: 0 0 10px 0; color: #1e40af;">üì± Mobile Device Detected</h4>
    <p style="margin: 0 0 10px 0;">Tap the button below to open the KwantaBit Dental app:</p>
    <a href="{{ deep_link_url }}" class="button" style="width: 100%; text-align: center;">
        Open in KwantaBit Dental App
    </a>
    <p style="font-size: 12px; color: #6b7280; margin: 10px 0 0 0;">
        Having trouble? <a href="#manual-instructions" style="color: #3b82f6;">View manual instructions</a>
    </p>
</div>

<!-- Enhanced manual instructions section -->
<div id="manual-instructions" class="step" style="display: none;">
    <h4 style="margin: 0 0 10px 0; color: #b91c1c;">üõ†Ô∏è Alternative Setup Methods</h4>
    
    <div style="margin: 15px 0;">
        <strong>Method 1: Copy & Paste Token</strong>
        <div class="manual-token" id="reset-token">
            {{ reset_token }}
        </div>
        <button class="copy-token" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 10px;">
            üìã Copy Token
        </button>
        <p style="font-size: 14px; color: #6b7280; margin: 10px 0 0 0;">
            Paste this token in the password reset screen
        </p>
    </div>
    
    <div style="margin: 15px 0;">
        <strong>Method 2: QR Code (Coming Soon)</strong>
        <p style="font-size: 14px; color: #6b7280; margin: 10px 0 0 0;">
            Scan with KwantaBit Dental app to auto-fill reset token
        </p>
    </div>
    
    <div style="margin: 15px 0;">
        <strong>Method 3: Direct URL</strong>
        <div style="background: #f3f4f6; padding: 12px; border-radius: 6px; font-family: monospace; font-size: 14px; word-break: break-all; margin: 10px 0;">
            <a href="{{ web_fallback_url }}" style="color: #3b82f6; text-decoration: none;">
                {{ web_fallback_url }}
            </a>
        </div>
        <p style="font-size: 14px; color: #6b7280; margin: 10px 0 0 0;">
            Open this URL in your browser
        </p>
    </div>
</div>

<!-- Add mobile detection script -->
<script>
    // Simple mobile detection
    if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        document.getElementById('mobile-deeplink').style.display = 'block';
    }
</script>
</body>
</html>